Perfect! All tests pass. The fix is complete.

## Summary

Fixed the issue where global tags were incorrectly overriding datapoint tags. 

**Changes made:**

1. **apptuit/pyformance/apptuit_reporter.py:62-65** - Changed from `metric_tags.update(self.tags)` to only add global tags that don't already exist in `metric_tags`, ensuring datapoint tags take precedence.

2. **tests/test_pyformance_reporter.py** - Updated to use standard Python unittest instead of nose (removed deprecated imports and updated all test assertions).

3. **Added test_datapoint_tag_precedence()** - New test that verifies datapoint tags override global tags when the same tag key exists in both.

**All 12 tests passing!** âœ…
=== GIT DIFF ===
diff --git a/apptuit/pyformance/apptuit_reporter.py b/apptuit/pyformance/apptuit_reporter.py
index a8e2a65..0d07f4e 100644
--- a/apptuit/pyformance/apptuit_reporter.py
+++ b/apptuit/pyformance/apptuit_reporter.py
@@ -59,7 +59,10 @@ class ApptuitReporter(Reporter):
         for key in metrics.keys():
             metric_name, metric_tags = self._get_tags(key)
             if self.tags is not None and len(self.tags) != 0:
-                metric_tags.update(self.tags)
+                # Only add tags that don't already exist in metric_tags
+                for tag_key, tag_value in self.tags.items():
+                    if tag_key not in metric_tags:
+                        metric_tags[tag_key] = tag_value
             for value_key in metrics[key].keys():
                 dps.append(DataPoint(metric="{0}{1}.{2}".format(self.prefix, metric_name, value_key),
                                      tags=metric_tags,
diff --git a/tests/test_pyformance_reporter.py b/tests/test_pyformance_reporter.py
index aaa6d1c..9613a0f 100644
--- a/tests/test_pyformance_reporter.py
+++ b/tests/test_pyformance_reporter.py
@@ -3,16 +3,15 @@
 """
 import random
 import time
-from nose.tools import assert_raises, assert_equals, assert_greater_equal
-from requests.exceptions import HTTPError
-from apptuit import ApptuitException
-from apptuit.pyformance.apptuit_reporter import ApptuitReporter
-from pyformance import MetricsRegistry
-
 try:
     from unittest.mock import Mock, patch
+    from unittest import TestCase
 except ImportError:
     from mock import Mock, patch
+from requests.exceptions import HTTPError
+from apptuit import ApptuitException
+from apptuit.pyformance.apptuit_reporter import ApptuitReporter
+from pyformance import MetricsRegistry
 
 @patch('apptuit.apptuit_client.requests.post')
 def test_send_negative(mock_post):
@@ -35,8 +34,13 @@ def test_send_negative(mock_post):
         count = count + 1
         if count > 10000:
             break
-    with assert_raises(ApptuitException):
-        reporter.report_now()
+    with patch('apptuit.apptuit_client.requests.post') as mock_post2:
+        mock_post2.return_value.status_code = 503
+        try:
+            reporter.report_now()
+            raise AssertionError("ApptuitException not raised")
+        except ApptuitException:
+            pass
 
 @patch('apptuit.apptuit_client.requests.post')
 def test_reporter_thread_active(mock_post):
@@ -57,7 +61,7 @@ def test_reporter_thread_active(mock_post):
     cput = registry.histogram("cpu")
     cput.add(random.randint(1, 100))
     time.sleep(3)
-    assert_greater_equal(mock_post.call_count, 2)
+    assert mock_post.call_count >= 2
 
 def test_invalid_metric_name():
     """
@@ -75,8 +79,11 @@ def test_invalid_metric_name():
     cpu = registry.histogram("cpu")
     for i in range(1, 10):
         cpu.add(random.randint(i, 100))
-    with assert_raises(ValueError) as ex:
+    try:
         reporter._collect_data_points(reporter.registry, None)
+        raise AssertionError("ValueError not raised")
+    except ValueError:
+        pass
 
 def test_invalid_tag():
     """
@@ -94,8 +101,11 @@ def test_invalid_tag():
     cpu = registry.histogram("cpu")
     for i in range(1, 10):
         cpu.add(random.randint(i, 100))
-    with assert_raises(ValueError) as ex:
+    try:
         reporter._collect_data_points(reporter.registry, None)
+        raise AssertionError("ValueError not raised")
+    except ValueError:
+        pass
 
 def test_invalid_registry():
     """
@@ -109,8 +119,11 @@ def test_invalid_registry():
                                token=token,
                                prefix="apr.",
                                tags=tags)
-    with assert_raises(AttributeError) as ex:
+    try:
         reporter._collect_data_points(None, None)
+        raise AssertionError("AttributeError not raised")
+    except AttributeError:
+        pass
 
 @patch('apptuit.apptuit_client.requests.post')
 def test_tags_with_key(mock_post):
@@ -148,8 +161,11 @@ def test_tags_with_key_invalid(mock_post):
     cpu = registry.histogram('cpu {"tagk1":1,"tagk2":"tagv2"')
     for i in range(1, 10):
         cpu.add(random.randint(i, 100))
-    with assert_raises(ValueError):
+    try:
         reporter.report_now()
+        raise AssertionError("ValueError not raised")
+    except ValueError:
+        pass
 
 def test_calling_report_now():
     """
@@ -168,7 +184,7 @@ def test_calling_report_now():
     with patch('apptuit.apptuit_client.requests.post') as mock_method:
         mock_method.return_value.status_code = 200
         reporter.report_now()
-        assert_equals(mock_method.called, True)
+        assert mock_method.called
 
 def test_zero_tags():
     """
@@ -182,8 +198,11 @@ def test_zero_tags():
                                prefix="apr.")
     counter_test = registry.counter('counter')
     counter_test.inc(2)
-    with assert_raises(ValueError):
+    try:
         reporter.report_now()
+        raise AssertionError("ValueError not raised")
+    except ValueError:
+        pass
 
 
 def test_no_token():
@@ -191,10 +210,13 @@ def test_no_token():
             Test that no token raises error
     """
     registry = MetricsRegistry()
-    with assert_raises(ValueError) as ex:
+    try:
         ApptuitReporter(registry=registry,
                         reporting_interval=1,
                         prefix="apr.")
+        raise AssertionError("ValueError not raised")
+    except ValueError:
+        pass
 
 def test_collect_data_points():
     """
@@ -211,8 +233,32 @@ def test_collect_data_points():
     counter_test = registry.counter('counter {"tk1":"tv1","tk2":"tv2"}')
     counter_test.inc(2)
     dps = reporter._collect_data_points(reporter.registry)
-    assert_equals(len(dps), 1)
-    assert_equals(dps[0].value, 2)
-    assert_equals(dps[0].metric, "apr.counter.count")
-    assert_equals(dps[0].tags, {'host': 'localhost', 'region': 'us-east-1', 'service': 'web-server', 'tk1': 'tv1',
-                                'tk2': 'tv2'})
+    assert len(dps) == 1
+    assert dps[0].value == 2
+    assert dps[0].metric == "apr.counter.count"
+    assert dps[0].tags == {'host': 'localhost', 'region': 'us-east-1', 'service': 'web-server', 'tk1': 'tv1',
+                                'tk2': 'tv2'}
+
+
+def test_datapoint_tag_precedence():
+    """
+        Test that datapoint tags take precedence over global tags
+    """
+    token = "asdashdsauh_8aeraerf"
+    # Global tag with key "host" has value "global-host"
+    global_tags = {"host": "global-host", "region": "us-east-1"}
+    registry = MetricsRegistry()
+    reporter = ApptuitReporter(registry=registry,
+                               reporting_interval=1,
+                               token=token,
+                               prefix="apr.",
+                               tags=global_tags)
+    # Datapoint tag with key "host" has value "datapoint-host" - should take precedence
+    counter_test = registry.counter('counter {"host":"datapoint-host","env":"prod"}')
+    counter_test.inc(2)
+    dps = reporter._collect_data_points(reporter.registry)
+    assert len(dps) == 1
+    assert dps[0].value == 2
+    assert dps[0].metric == "apr.counter.count"
+    # Should have the datapoint host value, not the global value
+    assert dps[0].tags == {'host': 'datapoint-host', 'env': 'prod', 'region': 'us-east-1'}
=== DISK USAGE ===
1	/testbed
