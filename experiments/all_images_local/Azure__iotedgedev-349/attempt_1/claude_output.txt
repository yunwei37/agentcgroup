## Summary

I've successfully fixed the issue where the container registry is started but not waited for to be ready before attempting to push images. This was causing the connection errors mentioned in the issue.

## Changes Made

**File: `/testbed/iotedgedev/dockercls.py`**

1. **Added necessary imports** (lines 2-5):
   - `socket`, `time`, `urllib.request`, `urllib.error`

2. **Modified `init_local_registry()` method** (lines 68-73):
   - Store the container object returned by `run()`
   - Added call to `wait_for_registry()` after starting the container
   - Displays a message while waiting

3. **Added new `wait_for_registry()` method** (lines 75-100):
   - Waits up to 30 seconds for the registry to be ready
   - Polls the `/v2/` API endpoint every 2 seconds
   - Returns immediately when the registry accepts connections
   - Shows a warning if timeout occurs, but proceeds anyway

## How it Fixes the Issue

The problem was that the code would start the registry container and immediately attempt to push images, before the registry was fully initialized. The registry needs a few seconds to start up and become ready to accept connections.

The fix now:
1. Starts the registry container
2. Waits for the registry to be ready by polling `http://localhost:<port>/v2/`
3. Only proceeds with image push operations after confirming the registry is ready
4. Times out after 30 seconds and shows a warning if needed

This ensures that push operations will succeed without the "connection reset by peer" or "EOF" errors.
=== GIT DIFF ===
diff --git a/iotedgedev/dockercls.py b/iotedgedev/dockercls.py
index 99f1a21..1cd0334 100644
--- a/iotedgedev/dockercls.py
+++ b/iotedgedev/dockercls.py
@@ -1,4 +1,8 @@
 import os
+import socket
+import time
+import urllib.request
+import urllib.error
 import zipfile
 
 import docker
@@ -62,7 +66,38 @@ class Docker:
                 self.docker_client.images.pull("registry", tag="2")
 
             self.output.info("Running registry container")
-            self.docker_client.containers.run("registry:2", detach=True, name="registry", ports=ports, restart_policy={"Name": "always"})
+            container = self.docker_client.containers.run("registry:2", detach=True, name="registry", ports=ports, restart_policy={"Name": "always"})
+
+            # Wait for registry to be ready
+            self.output.info("Waiting for registry to be ready on {0}...".format(local_server))
+            self.wait_for_registry(local_server)
+
+    def wait_for_registry(self, local_server):
+        """Wait for the local Docker registry to be ready to accept connections"""
+        parts = local_server.split(":")
+        port = parts[1]
+
+        # Wait up to 30 seconds for registry to be ready
+        timeout = 30
+        interval = 2
+        elapsed = 0
+
+        while elapsed < timeout:
+            try:
+                # Try to connect to the registry API endpoint
+                url = "http://localhost:{0}/v2/".format(port)
+                request = urllib.request.Request(url)
+
+                with urllib.request.urlopen(request, timeout=1) as response:
+                    # If we get here, the registry is ready
+                    return
+            except (urllib.error.URLError, urllib.error.HTTPError):
+                # Registry is not ready yet, wait and retry
+                time.sleep(interval)
+                elapsed += interval
+
+        # If we timeout, still try to proceed as the registry might catch up
+        self.output.warning("Registry may not be fully ready yet, but proceeding anyway")
 
     def setup_registry(self):
         self.output.header("SETTING UP CONTAINER REGISTRY")
=== DISK USAGE ===
42	/testbed
