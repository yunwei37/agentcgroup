# 多租户内存竞争实验计划

## 1. 实验目标

验证 memcg BPF struct_ops 在多进程并发竞争有限内存时，能否有效保护 HIGH 优先级进程。

## 2. 实验设计

### 2.1 Cgroup 结构

```
/sys/fs/cgroup/memcg_bpf_test/          # 父 cgroup，总内存限制 512MB
├── high_session/                        # HIGH 优先级，受保护
├── low_session_1/                       # LOW 优先级，被限流
└── low_session_2/                       # LOW 优先级，被限流
```

### 2.2 内存配置

| 参数 | 值 | 说明 |
|------|-----|------|
| 父 cgroup memory.max | 512 MB | 总内存上限 |
| 父 cgroup memory.swap.max | 0 | 禁用 swap |
| 每个进程目标内存 | 256 MB | 总需求 768MB > 512MB |
| memory.high (各子 cgroup) | 200 MB | 触发 BPF 回调的阈值 |

### 2.3 BPF 配置

| Cgroup | BPF ops | 效果 |
|--------|---------|------|
| high_session | high_mcg_ops | `below_low` 返回 true，受保护 |
| low_session_1 | low_mcg_ops | `get_high_delay_ms` 返回 2000ms |
| low_session_2 | low_mcg_ops | `get_high_delay_ms` 返回 2000ms |

### 2.4 实验组

| 组别 | 配置 | 预期结果 |
|------|------|---------|
| **Baseline** | 无 BPF，3 个进程公平竞争 | 所有进程完成时间相近 |
| **BPF-Protected** | 有 BPF，HIGH 受保护 | HIGH 快，LOW 慢 |

## 3. 实验流程

```
┌─────────────────────────────────────────────────────────────────┐
│ Phase 1: Setup                                                   │
├─────────────────────────────────────────────────────────────────┤
│ 1. 创建 cgroup 结构                                              │
│ 2. 设置内存限制                                                  │
│ 3. (BPF组) 附加 BPF struct_ops                                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Phase 2: Run Workloads (并发)                                   │
├─────────────────────────────────────────────────────────────────┤
│ ┌───────────┐  ┌───────────┐  ┌───────────┐                    │
│ │  HIGH     │  │  LOW 1    │  │  LOW 2    │                    │
│ │ 256MB     │  │ 256MB     │  │ 256MB     │                    │
│ │ alloc     │  │ alloc     │  │ alloc     │                    │
│ └─────┬─────┘  └─────┬─────┘  └─────┬─────┘                    │
│       └──────────────┼──────────────┘                           │
│                      ↓                                           │
│            竞争 512MB 总内存                                     │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Phase 3: Measure                                                 │
├─────────────────────────────────────────────────────────────────┤
│ - 各进程完成时间                                                 │
│ - memory.events.high 计数                                        │
│ - OOM 事件 (dmesg)                                              │
└─────────────────────────────────────────────────────────────────┘
```

## 4. 测量指标

| 指标 | 测量方法 | 意义 |
|------|---------|------|
| 完成时间 | 进程 start → end 时间戳 | 主要指标 |
| memory.events.high | 读取 cgroup 文件 | BPF 触发次数 |
| memory.events.max | 读取 cgroup 文件 | 达到限制次数 |
| OOM 事件 | dmesg \| grep oom | 稳定性 |

## 5. 预期结果

### 5.1 Baseline（无 BPF）

```
HIGH:   ████████████████████████████████  ~10s
LOW 1:  ████████████████████████████████  ~10s
LOW 2:  ████████████████████████████████  ~10s
        0        5        10       15 (seconds)
```

所有进程完成时间相近（公平竞争）。

### 5.2 BPF-Protected

```
HIGH:   ████████████  ~4s (快速完成)
LOW 1:  ████████████████████████████████████████  ~15s (被限流)
LOW 2:  ████████████████████████████████████████  ~15s (被限流)
        0        5        10       15       20 (seconds)
```

HIGH 进程快速完成，LOW 进程被 2s 延迟限流。

## 6. 所需脚本

### 6.1 memory_stress.py
- 分配指定大小内存
- 触发物理页分配（touch pages）
- 保持一段时间后退出
- 输出完成时间

### 6.2 setup_cgroups.sh
- 创建 cgroup 结构
- 设置内存限制
- 设置 memory.high 阈值

### 6.3 run_baseline.sh
- 运行无 BPF 的基准测试
- 收集结果

### 6.4 run_bpf_test.sh
- 附加 BPF struct_ops
- 运行测试
- 收集结果

### 6.5 analyze_results.py
- 解析结果
- 生成对比图表

## 7. 风险与备选

| 风险 | 影响 | 备选方案 |
|------|------|---------|
| BPF 附加失败 | 实验无法进行 | 使用 test_progs 中的加载方式 |
| 内存限制太紧 | OOM kill | 调大总限制 |
| 内存限制太松 | 无竞争 | 增加每进程目标内存 |

## 8. 执行步骤

```bash
# 1. 进入测试目录
cd /home/yunwei37/agentcgroup/memcg/multi_tenant_test

# 2. 运行 Baseline 测试
sudo ./run_baseline.sh

# 3. 运行 BPF 测试
sudo keyctl session - ./run_bpf_test.sh

# 4. 分析结果
python3 analyze_results.py
```
